{% extends "core/base.html" %}
{% load static %}

{% block content %}
<!-- Thêm DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">

<div class="container mt-4">
    <h2><i class="fas fa-coins"></i> Quản Lý Điểm Tích Lũy</h2>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="table-responsive">
        <table class="table" id="pointsTable">
            <thead>
                <tr>
                    <th><i class="fas fa-hashtag"></i> ID</th>
                    <th><i class="fas fa-user"></i> Chủ xe</th>
                    <th><i class="fas fa-car"></i> Xe</th>
                    <th><i class="far fa-calendar-alt"></i> Ngày bảo dưỡng</th>
                    <th><i class="fas fa-tools"></i> Nội dung</th>
                    <th><i class="fas fa-money-bill"></i> Chi phí</th>
                    <th><i class="fas fa-cogs"></i> Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr>
                    <td>{{ record.id }}</td>
                    <td>
                        {% if record.vehicle.owner.get_full_name %}
                            {{ record.vehicle.owner.get_full_name }}
                        {% else %}
                            {{ record.vehicle.owner.username }}
                        {% endif %}
                    </td>
                    <td>{{ record.vehicle.bien_so }}</td>
                    <td>{{ record.ngay_bao_duong|date:"d/m/Y" }}</td>
                    <td>{{ record.chi_phi|floatformat:0 }} VNĐ</td>
                    <td>{{ record.noi_dung|default:"-" }}</td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm" 
                                onclick="confirmApprove('{{ record.id }}', '{{ record.chi_phi }}')">
                            ✅ Duyệt điểm
                        </button>
                        
                        <button type="button" class="btn btn-danger btn-sm ms-2" 
                                onclick="confirmReject('{{ record.id }}')">
                            ❌ Từ chối
                        </button>

                        <form id="approveForm{{ record.id }}" 
                              action="{% url 'approve_point' record.id %}" 
                              method="post" style="display: none;">
                            {% csrf_token %}
                        </form>

                        <form id="rejectForm{{ record.id }}" 
                              action="{% url 'reject_point' record.id %}" 
                              method="post" style="display: none;">
                            {% csrf_token %}
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Không có bản ghi nào chờ duyệt điểm</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Thêm DataTables JS -->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    $('#pointsTable').DataTable({
        // Cấu hình DataTables
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/vi.json'
        },
        pageLength: 30,
        order: [[3, 'desc']], // Sắp xếp theo ngày bảo dưỡng mới nhất
        columnDefs: [
            {
                targets: -1, // Cột cuối cùng (thao tác)
                orderable: false, // Không cho phép sắp xếp
                searchable: false
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: 'Xuất Excel',
                className: 'btn btn-success btn-sm me-2',
                exportOptions: {
                    columns: [0,1,2,3,4,5] // Không xuất cột thao tác
                }
            },
            {
                extend: 'pdf',
                text: 'Xuất PDF',
                className: 'btn btn-danger btn-sm',
                exportOptions: {
                    columns: [0,1,2,3,4,5]
                }
            }
        ],
        initComplete: function () {
            // Thêm filter cho từng cột
            this.api().columns().every(function (index) {
                var column = this;
                
                // Bỏ qua cột thao tác
                if(index !== 6) {
                    var select = $('<select class="form-select form-select-sm"><option value="">Tất cả</option></select>')
                        .appendTo($(column.header()))
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex(
                                $(this).val()
                            );
                            column
                                .search(val ? '^' + val + '$' : '', true, false)
                                .draw();
                        });

                    column.data().unique().sort().each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>')
                    });
                }
            });
        }
    });
});

function confirmApprove(recordId, cost) {
    const points = Math.floor(parseFloat(cost) / 10000);
    
    Swal.fire({
        title: 'Xác nhận duyệt điểm',
        html: `
            <p>Bạn có chắc chắn muốn duyệt điểm cho bản ghi #${recordId}?</p>
            <p>Điểm sẽ được cộng: <strong>${points} điểm</strong></p>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Duyệt điểm',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById(`approveForm${recordId}`).submit();
        }
    });
}

function confirmReject(recordId) {
    Swal.fire({
        title: 'Xác nhận từ chối',
        text: `Bạn có chắc chắn muốn từ chối cộng điểm cho bản ghi #${recordId}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Từ chối điểm',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById(`rejectForm${recordId}`).submit();
        }
    });
}
</script>
{% endblock %}