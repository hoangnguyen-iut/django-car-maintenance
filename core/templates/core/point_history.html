{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="alert alert-info mb-4">
        <p class="mb-0">
            <i class="fas fa-star"></i> 
            Điểm tích lũy hiện tại: <strong>{{ user.userprofile.loyalty_points }}</strong> điểm
        </p>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Lịch sử điểm tích lũy</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="pointHistoryTable">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Hoạt động</th>
                            <th>Điểm</th>
                            <th>Lý do</th>
                            <th>Chi tiết bảo dưỡng</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in history %}
                        <tr>
                            <td>{{ record.created_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if record.action == 'add' %}
                                    <span class="badge bg-success">Cộng điểm</span>
                                {% else %}
                                    <span class="badge bg-danger">Trừ điểm</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.action == 'add' %}
                                    <span class="text-success">+{{ record.points }}</span>
                                {% else %}
                                    <span class="text-danger">{{ record.points }}</span>
                                {% endif %}
                            </td>
                            <td>{{ record.reason }}</td>
                            <td>
                                {% if record.maintenance_record %}
                                    <a href="{% url 'maintenance_list' %}">Xem chi tiết</a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Chưa có lịch sử điểm</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    div.dataTables_wrapper div.dataTables_length {
        margin-bottom: 12px;
    }

    div.dataTables_wrapper div.dataTables_filter {
        margin-top: 8px;
    }
</style>

<!-- Thêm DataTables -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
    $('#pointHistoryTable').DataTable({
        language: {
            emptyTable: "Không có dữ liệu",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
            infoEmpty: "Hiển thị 0 đến 0 của 0 mục",
            infoFiltered: "(được lọc từ _MAX_ mục)",
            lengthMenu: "Hiển thị _MENU_ mục",
            loadingRecords: "Đang tải...",
            processing: "Đang xử lý...",
            search: "Tìm kiếm:",
            zeroRecords: "Không tìm thấy kết quả",
            paginate: {
                first: "Đầu",
                last: "Cuối",
                next: "Tiếp",
                previous: "Trước"
            },
            aria: {
                sortAscending: ": kích hoạt để sắp xếp cột tăng dần",
                sortDescending: ": kích hoạt để sắp xếp cột giảm dần"
            }
        },
        order: [[0, 'desc']],
        pageLength: 20
    });
});
</script>
{% endblock %}